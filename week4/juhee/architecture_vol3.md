# 📘 7장. 분산 시스템을 위한 유일 ID 생성기 설계

### 목표

* 분산 환경에서 **중복되지 않는 ID**를 생성하는 시스템 설계.
* 요구사항:

  * **유일성 보장**
  * **숫자 기반**
  * **64비트 정수**
  * **시간 순 정렬 가능**
  * **높은 처리량(QPS ≥ 10,000)**

---

## 1. 요구사항 정의

설계 전 면접관과 질의응답을 통해 아래 요구를 확정한다.

### 기능적 요구사항

* ID는 **절대로 중복되면 안 된다**.
* ID는 **숫자로만 구성**되어야 한다.
* ID는 **64비트 정수**로 표현 가능해야 한다.
* ID는 **시간 순서대로 정렬 가능**해야 한다.
* **초당 최소 10,000개** 이상의 ID 생성 성능 필요.

---

## 2. 네 가지 기술적 접근 방식

### 2.1 다중 마스터 복제 (Multi-master Replication)

여러 DB 서버가 auto_increment 증가폭을 다르게 가져가도록 설정하여 충돌 방지.

#### 장점

* 구현 쉬움 (DB 기능 활용)

#### 단점

* 서버 추가/삭제 시 증가폭 재조정 어려움
* 여러 데이터센터에 배치하기 어려움
* 시간순 정렬 보장 어려움

---

### 2.2 UUID

128비트로 생성되는 고유 ID.

예: `09c93e62-50b4-468d-bf8a-c07e1040bfb2`

#### 장점

* 충돌 가능성이 거의 없음
* 서버 간 동기화가 불필요
* 확장성 매우 우수

#### 단점

* **128비트 → 64비트 요구사항 불충족**
* **시간 순 정렬 불가**
* **숫자가 아닌 문자 포함**

---

### 2.3 티켓 서버 (Ticket Server)

중앙 서버가 모든 ID를 생성하여 발급하는 방식.

#### 장점

* 유일성 확실히 보장
* 숫자 기반 ID 생성 쉬움
* 구현 단순

#### 단점

* **단일 장애 지점(SPOF)**
* 여러 티켓 서버 운영 시 동기화 문제 발생

---

### 2.4 트위터 스노플레이크 (Twitter Snowflake)

ID를 **시간 + 데이터센터 + 서버 + 시퀀스**로 조합하는 방식.

➡️ 이 문제의 모든 요구사항을 충족하기 때문에 최종 선택.

---

## 3. Snowflake 상세 설계

Snowflake는 64비트를 다음과 같이 분할한다:

```
| 1비트 | 41비트      | 5비트         | 5비트     | 12비트      |
| sign  | timestamp   | datacenter ID | server ID | sequence    |
```

### 3.1 Sign (1bit)

* 항상 0 (양수 표현)

### 3.2 Timestamp (41bit)

* 기준 시각(epoch) 이후 경과한 **밀리초(ms)**
* ID가 **시간 순으로 정렬**될 수 있게 함
* 41비트 → 약 **69년** 사용 가능

### 3.3 Datacenter ID (5bit)

* 최대 32개 데이터센터 구분 가능

### 3.4 Server ID (5bit)

* 각 데이터센터 내 최대 32개 서버 구분

### 3.5 Sequence (12bit)

* 같은 밀리초에 생성되는 ID들의 증가 값
* 0~4095 (4,096개)
* 밀리초가 바뀌면 0으로 초기화

---

## 4. Snowflake 운영 시 고려사항

### 4.1 시계 동기화 문제 (Clock Skew)

* 서버 간 시간이 다르면 ID 충돌 발생 가능
* NTP(Network Time Protocol)로 시간 정렬 필요
* 시간이 뒤로 움직이면 대기(wait) 처리 등 별도 로직 필요

### 4.2 비트 최적화

서비스 특성에 따라 비트 구성을 조정할 수 있음.
예:

* 동시성 낮음 → 시퀀스 비트를 줄이고 timestamp 비트 증가 가능
* 데이터센터가 많음 → datacenter ID 비트 확대

### 4.3 고가용성(HA)

* ID 생성기가 다운되면 서비스 전체가 멈출 수 있음 → 필수적으로 고가용성 구현 필요.

---

## 5. 결론

Snowflake 방식은 다음 조건을 모두 충족함:

| 요구사항     | 충족 여부 | 근거                   |
| -------- | ----- | -------------------- |
| 유일성      | ✔     | 데이터센터 + 서버 + 시퀀스 조합  |
| 숫자 기반    | ✔     | 64비트 정수              |
| 64비트     | ✔     | 비트 구조 자체가 64bit      |
| 시간 정렬 가능 | ✔     | 타임스탬프가 가장 큰 비중       |
| 고성능      | ✔     | 서버당 밀리초당 4096개 생성 가능 |

따라서 Snowflake는 **대규모 분산 시스템에 가장 적합한 ID 생성 방식**이다.

---
