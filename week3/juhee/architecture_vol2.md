# 📘 5장 — 안정 해시(Consistent Hashing) 정리

분산 시스템에서 서버 수가 변할 때 전체 데이터를 다시 배치해야 하는 문제를 해결하기 위해 등장한 기술이 **안정 해시(Consistent Hashing)** 이다.
이 문서는 안정 해시의 기본 개념부터 해시 링, 서버 배치, 키 매핑, 가상 노드, 재배치 범위까지 전체 흐름을 정리한다.

---

# 1. 🧨 기존 해시 방식의 한계

일반적인 분산 캐시 분배 공식은 다음과 같다.

```text
serverIndex = hash(key) % N
```

문제는 **서버 수 N이 변하면 모든 key의 서버 인덱스가 바뀐다는 것**이다.

예:

* 서버 4개 → %4
* 서버 3개로 줄어들면 → %3
  → 대부분의 key가 다른 서버로 이동
  → **대규모 캐시 미스 발생**

그래서 더 나은 방식이 필요하다.

---

# 2. 💡 안정 해시란?

> 안정 해시(Consistent Hashing)는 **서버 수가 변해도 전체 키 중 극히 일부만 재배치되는** 해싱 기법이다.

특징:

* 평균적으로 O(k/n)의 키만 재배치되며,
* 서버 변화가 있어도 전체 시스템에 영향이 최소화된다.

---

# 3. 🎯 해시 공간과 해시 링(Hash Ring)

SHA-1과 같은 해시 함수의 출력 범위를
`0 ~ 2^160-1` 범위의 선형 공간이라 할 때,

이를 **양 끝을 연결하여 원형으로 표현**한다.
이것이 **해시 링(Hash Ring)** 이다.

```
0 → 1 → 2 → ... → MAX → 다시 0 (순환)
```

이 링 위에 서버와 키가 위치한다.

---

# 4. 🏷 서버를 해시 링에 배치하기

각 서버의 IP 또는 이름을 해싱하여 링의 특정 위치에 매핑한다.

예시:

* s0 = 서버0
* s1 = 서버1
* s2 = 서버2
* s3 = 서버3

각 서버는 링 위에 특정 지점 하나를 차지한다.

---

# 5. 🔑 키를 해시 링에 배치하고 서버 찾기

키(key0, key1…)도 동일한 방식으로 링 위에 배치한다.

키가 어느 서버에 저장되는지는 다음 규칙으로 정한다:

### **📌 키의 위치에서 시계 방향으로 이동했을 때 처음 만나는 서버가 담당 서버이다.**

예:

* key0 → 시계 방향 첫 서버 s0
* key1 → s1
* key2, key3 → s3

---

# 6. 🛠 서버 추가/삭제 시 재배치

안정 해시의 핵심 장점: **일부 키만 움직인다.**

### ✅ 서버 추가 시

* 새 서버 s_new 위치에서
* **반시계 방향으로 돌면 처음 만나는 서버까지의 키만 재배치**

예: s4 추가

* s3와 s4 사이의 키만 s4로 이동

### ✅ 서버 삭제 시

* 삭제된 서버 s_dead가 갖고 있던 키만
* **시계방향 첫 서버로 이동**

예: s1 삭제

* s1과 s2 사이 키들이 s2로 이동

➡ 전체 재배치가 아니라 "인접한 구간만" 이동하는 것이 핵심

---

# 7. ⚠ 기본 안정 해시의 두 가지 문제

서버를 1회만 링에 배치하면 다음 문제가 생긴다.

### 문제 1) 파티션 크기 불균형

서버 위치가 랜덤이기 때문에
어떤 서버는 큰 공간을 맡고 어떤 서버는 작은 공간만 맡음

### 문제 2) 키의 균등 분포 실패

서버 간 간격이 고르지 않아 키가 특정 서버로 몰림

➡ 이를 해결하기 위해 **가상 노드(Virtual Node)** 개념이 등장

---

# 8. 🧩 가상 노드(Virtual Node) 도입

가상 노드는 다음 개념이다.

> **실제 서버를 해시 링에 여러 번 복제해서 배치한다.**

예:

* 서버0 → s0_0, s0_1, s0_2
* 서버1 → s1_0, s1_1, s1_2

이렇게 하면:

* 서버가 링 전체에 골고루 흩어짐
* 파티션이 균등해짐
* 키 분포 또한 균형적으로 배치됨

### 키의 저장 기준도 동일

* 키 → 시계 방향 → 처음 만나는 가상 노드
* 그 가상 노드가 속한 실제 서버가 key 저장

---

# 9. 📈 가상 노드의 효과와 트레이드오프

### ✔ 효과 1: 파티션 균등화

가상 노드 수가 많아질수록 파티션 불균형이 감소

### ✔ 효과 2: 키 분포 개선

표준편차가 작아져 키가 고르게 분포됨
(예: 100~200개의 가상 노드 사용 시 표준편차는 평균의 약 5~10%)

### ✔ 효과 3: 서버 추가/삭제 시 안정적

이동되는 키는 가상 노드 단위로 최소화됨

### ⚠ 단점: 관리 비용 증가

가상 노드 수가 많아질수록

* 메모리 사용 증가
* 해시 탐색 계산량 증가

➡ 시스템 사양에 맞게 적절한 가상 노드 수 선정 필요

---

# 📚 전체 흐름 요약

1. 전체 해시 공간을 원형으로 만든다 (해시 링)
2. 서버를 해싱하여 링에 배치
3. 키를 해싱하여 링에 배치
4. 키는 시계 방향 첫 서버가 담당
5. 서버 추가/삭제 시 인접한 범위 키만 이동
6. 가상 노드를 사용해 부하 균형을 맞춤

---

# ✔ 결론

안정 해시는 대규모 분산 시스템에서 서버 수 변동에도
데이터 이동량을 최소화하며 부하를 안정적으로 분배할 수 있는 핵심 기법이다.

**Memcached, Redis Cluster, Cassandra, DynamoDB 등**
다양한 시스템이 이 기법을 기반으로 동작한다.

---

